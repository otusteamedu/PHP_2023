version : '3'

services:
    nginx-main:
        build         :
            context   : ./docker/nginx
            dockerfile: Dockerfile
        image         : balance/nginx
        container_name: nginx-main
        ports         :
            - "30080:80"
        volumes       :
            - ./app:/var/www/otus-homework.loc
            - ./docker/nginx/config/nginx-balancer.conf:/etc/nginx/conf.d/default.conf
        depends_on    :
            - nginx1
            - nginx2
        networks      :
            - app-network

    nginx1    :
        build         :
            context   : ./docker/nginx
            dockerfile: Dockerfile
        image         : balance/nginx
        container_name: nginx1
        volumes       :
            - ./app:/var/www/otus-homework.loc
            - ./docker/nginx/config/php-fpm-balancer.conf:/etc/nginx/conf.d/default.conf
        depends_on    :
            - app1
            - app2
        networks      :
            - app-network

    nginx2    :
        build         :
            context   : ./docker/nginx
            dockerfile: Dockerfile
        image         : balance/nginx
        container_name: nginx2
        volumes       :
            - ./app:/var/www/otus-homework.loc
            - ./docker/nginx/config/php-fpm-balancer.conf:/etc/nginx/conf.d/default.conf
        depends_on    :
            - app1
            - app2
        networks      :
            - app-network

    app1      :
        build         :
            context   : ./docker/php-fpm
            dockerfile: Dockerfile
        image         : balance/php
        container_name: app1
        environment   :
            - MEMCACHED_PORT=11211
        volumes       :
            - ./app:/var/www/otus-homework.loc
        depends_on    :
            - memcached
        networks      :
            - app-network

    app2      :
        build         :
            context   : ./docker/php-fpm
            dockerfile: Dockerfile
        image         : balance/php
        container_name: app2
        environment   :
            - MEMCACHED_PORT=11211
        volumes       :
            - ./app:/var/www/otus-homework.loc
        depends_on    :
            - memcached
        networks      :
            - app-network

    cli:
        restart       : 'no'
        build         :
            context   : ./docker/php-cli
            dockerfile: Dockerfile
        command       : composer install --ignore-platform-reqs --no-scripts --no-progress
        image         : balance/php-cli
        container_name: cli
        volumes       :
            - ./app:/var/www/otus-homework.loc
        networks      :
            - app-network

    memcached :
        image         : memcached:latest
        container_name: memcached
        ports         :
            - "31211:11211"
        restart       : always
        networks      :
            - app-network

networks:
    app-network:
        driver: bridge