version: '3.9'

services:
  php:
    restart: unless-stopped
    image: otus-php:lastest
    build:
      context: .docker
      target: php_fpm
    volumes:
      - type: bind
        source: .volumes/php-socket
        target: /var/run/php
      - type: bind
        source: .
        target: /home/warp/app
    working_dir: /home/warp/app/website
    extra_hosts:
      - host.docker.internal:host-gateway

  nginx:
    restart: unless-stopped
    image: nginx:alpine
    volumes:
      - type: bind
        source: .volumes/php-socket
        target: /var/run/php
      - type: bind
        source: .
        target: /srv
      - type: bind
        source: .docker/nginx
        target: /etc/nginx/templates
    environment:
      NGINX_ENVSUBST_OUTPUT_DIR: /etc/nginx
      NGINX_ENVSUBST_TEMPLATE_SUFFIX: .tmpl
      NGINX_ROOT: /srv
      ROOT_DOMAIN: ${ROOT_DOMAIN}
      FPM_ROOT: /home/warp/app

  mysql:
    restart: unless-stopped
    image: percona:5.7
    command:
      - '--character-set-server=utf8'
      - '--collation-server=utf8_unicode_ci'
      - '--init-connect=SET collation_connection = utf8_general_ci'
      - '--init-connect=SET NAMES utf8'
      - '--init-connect=SET innodb_strict_mode=0'
      - '--sql-mode='
    environment:
      MYSQL_USER: ${DB_USER:-otus}
      MYSQL_PASSWORD: ${DB_USER_PASSWORD:-7e52fa183f09a4f8}
      MYSQL_DATABASE: ${DB_DATABASE:-otus}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-37ece454be1af34e}
    volumes:
      - type: volume
        source: mysql
        target: /var/lib/mysql
      - type: bind
        source: .volumes/mysql
        target: /mnt/mysql

  rabbitmq:
    restart: unless-stopped
    image: rabbitmq:3-management
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER:-otus}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS:-7e52fa183f09a4f8}
    volumes:
      - type: volume
        source: rabbitmq
        target: /var/lib/rabbitmq

  redis:
    restart: unless-stopped
    image: redis:7-alpine
    volumes:
      - type: volume
        source: redis
        target: /data:delegated

  memcached:
    restart: unless-stopped
    image: memcached:1-alpine

volumes:
  mysql:
  rabbitmq:
  redis: