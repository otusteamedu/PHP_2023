# PHP_2023

https://otus.ru/lessons/razrabotchik-php/?utm_source=github&utm_medium=free&utm_campaign=otus

# Задание

## Цель
В этом домашнем задании мы тренируем умение разрабатывать кейсы тестирования на трёх уровнях: 
- модульном
- интеграционном
- системном. 

Данное умение необходимо, если разрабатываемое приложение покрывается тестами с какими-либо целями.

## Описание/Пошаговая инструкция выполнения домашнего задания

- Скачать файл с заданием https://drive.google.com/file/d/1yAtmj9DE2yFeGh26WxDwr42j7RVbB_PI/view?usp=sharing
- Внутри файла содержится задача, результат выполнения задачи необходимо сохранить в md-файл или doc-файл.
- Полученный файл выложить в git, Google Drive или любой другой файлообменник.
- Ссылку на файл прислать в чат с преподавателем.

## Критерии оценки

Критерии оценивания содержатся внутри файла с задачей.

# Решение

## Модульные тесты

Card number:
- Если строка пуста, то тестируемый метод возвращает 400 с сообщением об ошибке;
- Если строка содержит больше 16 символов, то тестируемый метод возвращает 400 с сообщением об ошибке;
- Если строка содержит любой символ, кроме цифр, то тестируемый метод возвращает 400 с сообщением об ошибке;

Card holder:
- Если строка пуста, то тестируемый метод возвращает 400 с сообщением об ошибке;
- Если строка содержит более одного пробела, то тестируемый метод возвращает 400 с сообщением об ошибке;
- Если строка содержит пробел в начале или в конце строки, то тестируемый метод возвращает 400 с сообщением об ошибке;
- Если строка содержит любой символ кроме латинских букв или дефиса, то тестируемый метод возвращает 400 с сообщением об ошибке;
- Если строка содержит 2 дефиса подряд, то тестируемый метод возвращает 400 с сообщением об ошибке;
- Если строка начинается или заканчивается дефисом, то тестируемый метод возвращает 400 с сообщением об ошибке;

Card expiration:
- Если строка пуста, то тестируемый метод возвращает 400 с сообщением об ошибке;
- Если строка содержит не 5 символов, то тестируемый метод возвращает 400 с сообщением об ошибке;
- Если строка содержит любой символ кроме числа и слеша '/', то тестируемый метод возвращает 400 с сообщением об ошибке
- Если строка не соответствует формату '<число><число>/<число><число>', то тестируемый метод возвращает 400 с сообщением об ошибке
- Если 2 первых символа, после конвертации в число, больше 12, то тестируемый метод возвращает 400 с сообщением об ошибке
- Если 2 первых символа, после конвертации в число, равны 0, то тестируемый метод возвращает 400 с сообщением об ошибке
- Если месяц и год, переданные в строке, после конвертации в дату меньше текущего месяца и года, то тестируемый метод возвращает 400 с сообщением об ошибке

CVV:
- Если строка пуста, то тестируемый метод возвращает 400 с сообщением об ошибке
- Если строка содержит не 3 символа, то тестируемый метод возвращает 400 с сообщением об ошибке
- Если какой либо из символов в строке не является числом, то тестируемый метод возвращает 400 с сообщением об ошибке

Order number:
- Если строка пуста, то тестируемый метод возвращает 400 с сообщением об ошибке
- Если строка содержит больше 16 символов, то тестируемый метод возвращает сообщение об ошибке

Sum:
- Если строка пуста, то тестируемый метод возвращает 400 с сообщением об ошибке
- Если в строке есть символы кроме цифр и запятой, то тестируемый метод возвращает 400 с сообщением об ошибке
- Если в строке содержится более одной запятой, то тестируемый метод возвращает 400 с сообщением об ошибке
- Если в строка начинается или заканчивается запятой, то тестируемый метод возвращает 400 с сообщением об ошибке
- Если строка до запятой равно '0' и после запятой равнa '0' (если есть), то тестируемый метод возвращает 400 с сообщением об ошибке

## Интеграционные тесты

Фронт-бекенд:
- Если card_number пуст, то после получения ответа, поле "Номер карты" подсвечивается красной рамкой
- Если card_number содержит латинские буквы, то после получения ответа, поле "Номер карты" подсвечивается красной рамкой
- Если card_number содержит 10 символов, то после получения ответа, поле "Номер карты" подсвечивается красной рамкой

- Если card_holder пуст, то после получения ответа, поле "Владелец карты" подсвечивается красной рамкой
- Если card_holder содержит кириллические символы, то после получения ответа, поле "Владелец карты" подсвечивается красной рамкой
- Если card_holder содержит 2 пробела в между именем и фамилией, то после получения ответа, поле "Владелец карты" подсвечивается красной рамкой

- Если card_expiration пуст, то после получения ответа, поле "Срок действия карты" подсвечивается красной рамкой
- Если card_expiration содержит латинские символы, то после получения ответа, поле "Срок действия карты" подсвечивается красной рамкой
- Если card_expiration содержит дату меньше текущего месяца и года, то после получения ответа, поле "Срок действия карты" подсвечивается красной рамкой

и т.д.

- Если поля заполнены правильно, то появляется сообщение об успешной оплате

Бекенд-репозиторий:
- Если заказ по номеру существует и сумма соответствует сумме заказа, то после setOrderIsPaid, возвращается положительный ответ
- Если заказа не существует, то выбрасывается исключение OrderCannotBeFoundException
- Если заказ существует,но сумма не равно сумме заказа, то выбрасывается исключение SumIsNotSameException

Бекэнд-сервис А:
- Если все поля верны, то после отправки всех данных, сервис возвращает 200 ответ
- Если какое либо из полей не верно, сервис возвращает 403 ответ

## Системные тесты

- Если пользователь заполнил все поля правильно, то появляется сообщение об успешной оплате и в базе данных появляется запись об успешной оплате
- Если пользователь заполнил поля формы недействительными, но правильно написанными (согласно валидации полей) данными, то после отправки формы, пользователю выводится сообщение об ошибке оплаты "Такого пользователя не существует. проверьте правильность заполнения полей"
- Если у пользователя cvv неверные, то после отправки формы, пользователю выводится сообщение об ошибке оплаты "Не удалось списать деньги. Проверьте правильность заполнения полей"

## Удешевление тестирования

Так как у нас есть проблема с тестированием сервиса оплаты А, то мы можем удешевить наши запросы 2-я способами:
1) На этапе интеграционного тестирования Бекенд-сервис А, мы можем использовать mock-объекты
2) Во всех остальных случаях (кроме модульного тестирования), мы можем сделать отдельный максимально простой сервис, который будет всегда отвечать одним и тем же ответом на одни и те же данные (DummyService) и упрощённо реагировать на невалидные данные, отвечая 403 ответом, если хотя бы одно из ожидаемых полей неправильно

Пример:

```php
class DummyServiceA 
{
    private const CARD_NUMBER = '123';
    private const CARD_HOLDER = 'John Doe';
    private const CARD_EXPIRATION = '11/99';
    private const SUM = '123.123';
    
    public function makePayment(Request $request): void
    {
        if (
            $request->get('card_number') !== self::CARD_NUMBER ||
            $request->get('card_holder') !== self::CARD_HOLDER ||
            $request->get('card_expiration') !== self::CARD_EXPIRATION ||
            $request->get('sum') !== self::SUM
        ) {
            header('HTTP/1.1 403 Forbidden');
            die();
        }
        
         header('HTTP/1.1 200 OK');
         die();
    }
}
```
