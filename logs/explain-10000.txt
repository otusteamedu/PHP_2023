1. ANALYSE movies;
   EXPLAIN SELECT m.name
   FROM movies m
   INNER JOIN schedules s on m.id = s.movie_id
   WHERE s.datetime >= date_trunc('day', now() at time zone 'Europe/Moscow')
       AND s.datetime <= now();

Nested Loop  (cost=0.29..621.92 rows=46 width=26)
  ->  Seq Scan on schedules s  (cost=0.00..324.00 rows=46 width=8)
"        Filter: ((datetime <= now()) AND (datetime >= date_trunc('day'::text, (now() AT TIME ZONE 'Europe/Moscow'::text))))"
  ->  Index Scan using movies_pkey on movies m  (cost=0.29..6.48 rows=1 width=34)
        Index Cond: (id = s.movie_id)

// ===============================

2. ANALYSE tickets;
   EXPLAIN SELECT count(created_at)
   FROM tickets
   WHERE created_at >= date_trunc('day', (now() at time zone 'Europe/Moscow' - interval '1 week'))
     AND created_at <= now();

Finalize Aggregate  (cost=132074.94..132074.95 rows=1 width=8)
  ->  Gather  (cost=132074.73..132074.94 rows=2 width=8)
        Workers Planned: 2
        ->  Partial Aggregate  (cost=131074.73..131074.74 rows=1 width=8)
              ->  Parallel Seq Scan on tickets  (cost=0.00..124824.75 rows=2499991 width=8)
"                    Filter: ((created_at <= now()) AND (created_at >= date_trunc('day'::text, ((now() AT TIME ZONE 'Europe/Moscow'::text) - '7 days'::interval))))"
JIT:
  Functions: 7
"  Options: Inlining false, Optimization false, Expressions true, Deforming true"


// ===============================

3. ANALYSE movies;
   EXPLAIN SELECT movies.*, string_agg(g.name, ',') as genger
   FROM movies
   INNER JOIN schedules s on movies.id = s.movie_id
   LEFT JOIN movie_genres mg on movies.id = mg.movie_id
   LEFT JOIN genres g on g.id = mg.genre_id
   WHERE s.datetime >= date_trunc('day', now() at time zone 'Europe/Moscow')
     AND s.datetime <= now()
   GROUP BY movies.id;

GroupAggregate  (cost=646.36..647.28 rows=46 width=374)
  Group Key: movies.id
  ->  Sort  (cost=646.36..646.47 rows=46 width=374)
        Sort Key: movies.id
        ->  Nested Loop Left Join  (cost=0.72..645.09 rows=46 width=374)
              ->  Nested Loop Left Join  (cost=0.57..637.05 rows=46 width=350)
                    ->  Nested Loop  (cost=0.29..621.92 rows=46 width=342)
                          ->  Seq Scan on schedules s  (cost=0.00..324.00 rows=46 width=8)
"                                Filter: ((datetime <= now()) AND (datetime >= date_trunc('day'::text, (now() AT TIME ZONE 'Europe/Moscow'::text))))"
                          ->  Index Scan using movies_pkey on movies  (cost=0.29..6.48 rows=1 width=342)
                                Index Cond: (id = s.movie_id)
                    ->  Index Only Scan using movie_genres_pkey on movie_genres mg  (cost=0.29..0.32 rows=1 width=16)
                          Index Cond: (movie_id = movies.id)
              ->  Index Scan using genres_pkey on genres g  (cost=0.15..0.17 rows=1 width=40)
                    Index Cond: (id = mg.genre_id)

// ===============================

4. ANALYSE tickets;
   EXPLAIN SELECT m.id, m.name, sum(amount) as amount
   FROM tickets
   INNER JOIN movies m on m.id = tickets.movie_id
   WHERE datetime >= date_trunc('day', (now() at time zone 'Europe/Moscow' - interval '1 week'))
     AND datetime <= now()
   GROUP BY m.id, m.name
   ORDER BY amount DESC
   LIMIT 3;

Limit  (cost=131252.51..131252.52 rows=3 width=66)
  ->  Sort  (cost=131252.51..131277.51 rows=10000 width=66)
        Sort Key: (sum(tickets.amount)) DESC
        ->  Finalize GroupAggregate  (cost=128514.77..131123.27 rows=10000 width=66)
              Group Key: m.id
              ->  Gather Merge  (cost=128514.77..130848.27 rows=20000 width=66)
                    Workers Planned: 2
                    ->  Sort  (cost=127514.75..127539.75 rows=10000 width=66)
                          Sort Key: m.id
                          ->  Partial HashAggregate  (cost=126725.36..126850.36 rows=10000 width=66)
                                Group Key: m.id
                                ->  Hash Join  (cost=702.00..125939.85 rows=157101 width=39)
                                      Hash Cond: (tickets.movie_id = m.id)
                                      ->  Parallel Seq Scan on tickets  (cost=0.00..124825.29 rows=157101 width=13)
"                                            Filter: ((datetime <= now()) AND (datetime >= date_trunc('day'::text, ((now() AT TIME ZONE 'Europe/Moscow'::text) - '7 days'::interval))))"
                                      ->  Hash  (cost=577.00..577.00 rows=10000 width=34)
                                            ->  Seq Scan on movies m  (cost=0.00..577.00 rows=10000 width=34)
JIT:
  Functions: 19
"  Options: Inlining false, Optimization false, Expressions true, Deforming true"

// ===============================

5. ANALYSE places;
   EXPLAIN SELECT places.*, case when t.id IS NOT NULL then true else false end as booked
   FROM places
   INNER JOIN schedules s on places.cinema_hall_id = s.cinema_hall_id
   LEFT JOIN tickets t on places.id = t.place_id and s.movie_id = t.movie_id
   WHERE s.id = 9;

Hash Right Join  (cost=26.12..161103.55 rows=200 width=33)
  Hash Cond: ((t.place_id = places.id) AND (t.movie_id = s.movie_id))
  ->  Seq Scan on tickets t  (cost=0.00..116075.25 rows=6000025 width=24)
  ->  Hash  (cost=23.12..23.12 rows=200 width=40)
        ->  Hash Join  (cost=8.31..23.12 rows=200 width=40)
              Hash Cond: (places.cinema_hall_id = s.cinema_hall_id)
              ->  Seq Scan on places  (cost=0.00..11.00 rows=600 width=32)
              ->  Hash  (cost=8.30..8.30 rows=1 width=16)
                    ->  Index Scan using schedules_pkey on schedules s  (cost=0.29..8.30 rows=1 width=16)
                          Index Cond: (id = 9)
JIT:
  Functions: 25
"  Options: Inlining false, Optimization false, Expressions true, Deforming true"

// ===============================

6. ANALYSE schedule_prices;
   EXPLAIN SELECT min(sp.price) as min_price, max(sp.price) as max_price
   FROM schedule_prices sp
   WHERE sp.schedule_id = 9;

Aggregate  (cost=11.09..11.10 rows=1 width=64)
  ->  Index Scan using schedule_prices_pkey on schedule_prices sp  (cost=0.29..11.08 rows=2 width=5)
        Index Cond: (schedule_id = 9)
