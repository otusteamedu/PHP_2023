# PHP_2023

https://otus.ru/lessons/razrabotchik-php/?utm_source=github&utm_medium=free&utm_campaign=otus

# Задание

## Описание/Пошаговая инструкция выполнения домашнего задания:
Выберите один из своих проектов.
* Проведите анализ на предмет соответствия изученным принципам.
* Предложите свои варианты исправления.

## Критерии оценки:
* Все утверждения подкреплены кодом "до" и "после" (8 баллов)
* Желательно составить uml-схемы "до" и "после" (2 балла)

# Задание проекта 

Аналитик хочет иметь систему со следующими возможностями:

Система должна хранить события, которые в последующем будут отправляться сервису событий

События характеризуются важностью (аналитик готов выставлять важность в целых числах)

События характеризуются критериями возникновения. Событие возникает только если выполнены все критерии его возникновения. Для простоты все критерии заданы так: <критерий>=<значение>

Таким образом предположим, что аналитик заносит в систему следующие события:
```text
{
priority: 1000,
conditions: {
param1 = 1
},
event: {
::event::
},
},
{
priority: 2000,
conditions: {
param1 = 2,
param2 = 2
},
event: {
::event::
},
},
{
priority: 3000,
conditions: {
param1 = 1,
param2 = 2
},
event: {
::event::
},
},
От пользователя приходит запрос:
{
params: {
param1 = 1,
param2 = 2
}
}
```
Под этот запрос подходят первая и третья запись, т.к. в них обеих выполнены все условия, но приоритетнее третья, так как имеет больший priority.

Написать систему, которая будет уметь:

* добавлять новое событие в систему хранения событий
* очищать все доступные события
* отвечать на запрос пользователя наиболее подходящим событием
* использовать для хранения событий redis

## Критерии оценки:
Желательно параллельно попрактиковаться и выполнить ДЗ в других NoSQL хранилищах

Слой кода, отвечающий за работу с хранилищем должен позволять легко менять хранилище.

# Установка

## Изолированное окружение

Для развёртывания изолированного окружения пропишите команду
```bash
vagrant up
```

После установки, зайдите в ОС
```bash
vagrant ssh
```

## Подготовка и запуск среды
```bash
cd /vagrant/application && cp .env.example .env
```

Далее, заполните все пустые строки нужными данными в файле `.env`

После чего выполните команду

```bash
sudo docker compose up -d
```

Установите зависимости composer
```bash
sudo docker compose exec -it fpm bash
cd /data/www && composer install
```

Добавьте сайт `mysite.local` в файл `hosts`
```bash
127.0.0.1 mysite.local
```

Готово!

# Использование

Сайт поддерживает 4 роута

GET / - выводит список доступных методов
POST /add - добавляет элемент(ы) в список
POST /clear - очищает все события
POST /get - возвращает событие по заданному критерию

Для тестирования можно использовать Postman. Для метода /add можно добавить следующие данные в формате JSON в теле запроса
```json
[
  {
    "priority": 1000,
    "conditions": {
      "param1": 1
    },
    "event": "event1"
  },
  {
    "priority": 2000,
    "conditions": {
      "param1": 2,
      "param2": 2
    },
    "event": "event2"
  },
  {
    "priority": 3000,
    "conditions": {
      "param1": 1,
      "param2": 2
    },
    "event": "event3"
  },
  {
    "priority": 4000,
    "conditions": {
      "param1": 1,
      "param2": 2
    },
    "event": "event4"
  },
  {
    "priority": 5000,
    "conditions": {
      "param1": 1,
      "param2": 2
    },
    "event": "event5"
  }
]
```

Для получения данных можно использовать метод /get в формате JSON в теле запроса
```json
{
    "param1": 1,
    "param2": 2
}
```

Для использования Redis в .env нужно указать
```dotenv
STORAGE=redis
```

Для использования mongodb в .env нужно указать
```dotenv
STORAGE=mongo
```