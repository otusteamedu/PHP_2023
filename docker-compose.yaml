version: '3'

services:
  nginx_balancer:
    hostname: otus.local
    build:
      context: ./docker
      dockerfile: nginx/balancer/Dockerfile
    volumes:
      - ./:/app/otus.local
    container_name: "${NGINX_BALANCER_NAME}"
    depends_on:
      - nginx-worker-1
      - nginx-worker-2
    ports:
      - "${NGINX_EXTERNAL_PORT}:80"
    networks:
      - app-network

  nginx-worker-1:
    build:
      context: ./docker
      dockerfile: nginx/worker/Dockerfile
    volumes:
      - ./:/app/otus.local
    container_name: "${NGINX_WORKER_1}"
    depends_on:
      - php-fpm-1
      - php-fpm-2
    networks:
      - app-network

  nginx-worker-2:
    build:
      context: ./docker
      dockerfile: nginx/worker/Dockerfile
    volumes:
      - ./:/app/otus.local
    container_name: "${NGINX_WORKER_2}"
    depends_on:
      - php-fpm-1
      - php-fpm-2
    networks:
      - app-network

  php-fpm-1:
    build:
      context: ./docker
      dockerfile: php_fpm/Dockerfile
    volumes:
      - ./:/app/otus.local
    container_name: "${PHP_FPM_CONTAINER_1}"
    depends_on:
      - memcached
    networks:
      - app-network

  php-fpm-2:
    build:
      context: ./docker
      dockerfile: php_fpm/Dockerfile
    volumes:
      - ./:/app/otus.local
    container_name: "${PHP_FPM_CONTAINER_2}"
    depends_on:
      - memcached
    networks:
      - app-network

  php-cli:
    build:
      context: ./docker
      dockerfile: php_cli/Dockerfile
    volumes:
      - ./:/app/otus.local
    working_dir: /app/otus.local
    container_name: ${PHP_CLI_CONTAINER_NAME}
    networks:
      - app-network

  memcached:
    image: memcached:1.6-alpine
    container_name: "${MEMCACHED_CONTAINER_NAME}"
    networks:
      - app-network

networks:
  app-network:
    driver: bridge